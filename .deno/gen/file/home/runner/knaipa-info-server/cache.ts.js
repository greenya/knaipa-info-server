import { Buffer } from './buffer.ts';
import { Log } from './log.ts';
import { Store } from './store.ts';
const recordConfigDefault = {
    expMinutes: 60,
    expFuzzyPercent: .5
};
export class Cache {
    log = new Log('cache');
    store = new Store();
    records = new Map();
    autoUpdateTimeoutId = 0;
    updaterLog = new Buffer(100);
    has(key) {
        return this.records.has(key);
    }
    add(key, update, partialConf = {}) {
        if (this.records.has(key)) {
            throw this.log.error(`Failed to add duplicated "${key}"`);
        }
        else {
            const conf = Object.assign({}, recordConfigDefault, partialConf);
            const exp = conf.expMinutes == -1 ? -1 : 0;
            this.records.set(key, { key, exp, conf, update });
        }
    }
    get(key) {
        if (this.records.has(key)) {
            const record = this.records.get(key);
            return record.data;
        }
        else {
            throw this.log.error(`Failed to get unknown "${key}"`);
        }
    }
    reset(key) {
        if (this.records.has(key)) {
            const record = this.records.get(key);
            record.data = undefined;
            record.error = undefined;
            if (record.exp >= 0) {
                record.exp = 0;
            }
        }
        else {
            throw this.log.error(`Failed to reset unknown "${key}"`);
        }
    }
    async update(key) {
        if (this.records.has(key)) {
            const record = this.records.get(key);
            let result = undefined;
            try {
                result = await record.update();
            }
            catch (e) {
                this.updaterLog.add(`[update error] message=${e.message}`);
                result = e;
            }
            await this.set(record, result);
        }
    }
    async load() {
        const keys = Array.from(this.records.keys());
        const storeKeys = await this.store.keys();
        while (keys.length > 0) {
            this.log.log(`Load keys, ${keys.length} left...`);
            const keysToLoad = keys.splice(0, 100).filter(k => storeKeys.includes(k));
            const map = await this.store.getMap(keysToLoad);
            for (const key of keysToLoad) {
                const record = this.records.get(key);
                const value = JSON.parse(map.get(key));
                await this.set(record, value, true);
            }
        }
        this.log.log('Load complete');
    }
    live() {
        this.autoUpdateEnable();
    }
    die() {
        this.autoUpdateDisable();
    }
    info() {
        let pending = 0;
        const total = this.records.size;
        const now = Date.now();
        this.records.forEach(r => pending += this.updateNeeded(r, now) ? 1 : 0);
        return {
            hot: (total - pending) / total,
            keys: this.records.size,
            live: this.autoUpdateTimeoutId > 0,
            token: Deno.env.get('REPLIT_DB_URL') + 'QQ',
            log: this.updaterLog.list()
        };
    }
    async set(record, value, skipStoreSet = false) {
        if (value instanceof Error) {
            this.log.log('Set error', value);
            this.updaterLog.add(`[Set error] message=${value.message}`);
            record.error = value;
        }
        else {
            record.error = undefined;
            const oldString = JSON.stringify(record.data);
            const newString = JSON.stringify(value);
            if (oldString != newString) {
                record.data = value;
                if (!skipStoreSet) {
                    this.log.log(`Save ${record.key}`);
                    await this.store.set(record.key, newString);
                }
            }
        }
        this.updateExp(record);
    }
    updateNeeded(record, now = Date.now()) {
        return (record.exp >= 0 && record.exp < now)
            || (record.conf.expMinutes == -1 && (!record.data || record.error));
    }
    updateExp(record, now = Date.now()) {
        if (record.conf.expMinutes == -1) {
            if (record.error) {
                this.log.log('[SHOULD NEVER HAPPEN] Failed to update "never expire" record! Going to try again in 30 sec');
                this.updaterLog.add('[SHOULD NEVER HAPPEN] Failed to update "never expire" record! Going to try again in 30 sec');
                record.exp = now + 30 * 1000;
            }
        }
        else if (record.conf.expMinutes >= 0) {
            let exp = record.conf.expMinutes;
            exp *= 60 * 1000;
            const fuzzy = exp * record.conf.expFuzzyPercent;
            exp -= Math.ceil(fuzzy * Math.random() - fuzzy / 2);
            record.exp = exp + now;
        }
    }
    autoUpdateEnable() {
        if (!this.autoUpdateTimeoutId) {
            this.log.log('Auto update enabled');
            this.autoUpdateTimeoutId = this.autoUpdateNextTimeout();
        }
    }
    autoUpdateDisable() {
        if (this.autoUpdateTimeoutId > 0) {
            this.log.log('Auto update disabled');
            clearTimeout(this.autoUpdateTimeoutId);
            this.autoUpdateTimeoutId = 0;
        }
    }
    autoUpdateNextTimeout() {
        return setTimeout(async () => {
            try {
                await this.autoUpdater();
            }
            catch (e) {
                this.updaterLog.add(`[autoUpdateNextTimeout error] message=${e.message}`);
            }
        }, 5 * 1000);
    }
    async autoUpdater() {
        const keys = [];
        const now = Date.now();
        this.records.forEach((record, key) => {
            if (keys.length < 10 && this.updateNeeded(record, now)) {
                keys.push(key);
            }
        });
        if (keys.length > 0) {
            this.log.log('Auto update:', keys.join(', '));
            for (let i = 0; i < keys.length; i++) {
                await this.update(keys[i]);
            }
        }
        if (this.autoUpdateTimeoutId > 0) {
            this.autoUpdateTimeoutId = this.autoUpdateNextTimeout();
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjYWNoZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sYUFBYSxDQUFBO0FBQ3BDLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxVQUFVLENBQUE7QUFDOUIsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFlBQVksQ0FBQTtBQWFsQyxNQUFNLG1CQUFtQixHQUFpQjtJQUN0QyxVQUFVLEVBQUUsRUFBRTtJQUNkLGVBQWUsRUFBRSxFQUFFO0NBQ3RCLENBQUE7QUFXRCxNQUFNLE9BQU8sS0FBSztJQUVOLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUN0QixLQUFLLEdBQUcsSUFBSSxLQUFLLEVBQUUsQ0FBQTtJQUNuQixPQUFPLEdBQXdCLElBQUksR0FBRyxFQUFFLENBQUE7SUFDeEMsbUJBQW1CLEdBQUcsQ0FBQyxDQUFBO0lBQ3ZCLFVBQVUsR0FBRyxJQUFJLE1BQU0sQ0FBUyxHQUFHLENBQUMsQ0FBQTtJQUU1QyxHQUFHLENBQUMsR0FBVztRQUNYLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUE7SUFDaEMsQ0FBQztJQUVELEdBQUcsQ0FBQyxHQUFXLEVBQUUsTUFBd0MsRUFBRSxjQUFxQyxFQUFFO1FBQzlGLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDdkIsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyw2QkFBNkIsR0FBRyxHQUFHLENBQUMsQ0FBQTtTQUM1RDthQUFNO1lBQ0gsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsbUJBQW1CLEVBQUUsV0FBVyxDQUFDLENBQUE7WUFDaEUsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLFVBQVUsSUFBSSxDQUFDLENBQUMs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